# reTerminal E1002 HA 显示仪表板

在 reTerminal E1002 的六色墨水屏上显示 Home Assistant 实体状态。创建彩色仪表板并自动更新。

## 功能特性

- **网页配网（Captive Portal）** - 无需硬编码 WiFi 凭据
- 订阅任意 Home Assistant 实体
- 六色墨水屏（800x480）
- 美观的彩色仪表板界面
- 按设备类别颜色编码的实体卡片
- 最多 6 个实体卡片
- 自动显示刷新
- 连接状态指示
- 智能刷新逻辑（避免不必要的更新）
- **GPIO3 重置按钮** - 长按 6 秒清除 WiFi 凭据
- **GPIO6 状态 LED** - 提供视觉反馈
- **GPIO45 蜂鸣器** - WiFi 重置声音反馈

## 硬件要求

- **reTerminal E1002** 带六色墨水屏
- 显示分辨率：800x480
- GPIO3：重置按钮（长按 6 秒重置 WiFi）
- GPIO6：状态 LED（低电平点亮）
- GPIO45：蜂鸣器（声音反馈）

## 支持的颜色

6 种可用颜色：

| 颜色常量 | 说明 |
|---------|------|
| `TFT_WHITE` | 白色 |
| `TFT_BLACK` | 黑色 |
| `TFT_RED` | 红色 |
| `TFT_GREEN` | 绿色 |
| `TFT_BLUE` | 蓝色 |
| `TFT_YELLOW` | 黄色 |

## 软件依赖

### 需要安装的库

| 库名称 | 来源 | 说明 |
|-------|------|------|
| **Seeed_GFX** | [GitHub](https://github.com/Seeed-Studio/Seeed_GFX) | 墨水屏图形库 |
| **ArduinoJson** | 库管理器 | JSON 解析 |
| **WebSockets** | 库管理器 | WebSocket 通信 |

### SeeedHADiscovery 库

从 [GitHub](https://github.com/limengdu/SeeedHADiscovery) 手动安装。

## 快速开始

### 1. 上传固件

1. 选择 reTerminal E1002 对应的开发板
2. 确保在 User_Setup.h 中定义了 `EPAPER_ENABLE`
3. 上传程序

### 2. WiFi 配网

首次启动（或重置后），设备会进入配网模式：

1. 墨水屏显示彩色配网界面，提示连接 AP
2. 用手机或电脑连接 WiFi：**reTerminal_E1002_AP**
3. 打开浏览器访问：**http://192.168.4.1**
4. 选择你的 WiFi 网络并输入密码
5. 设备自动连接并显示 IP 地址

> **重置 WiFi**：长按 GPIO3 按钮 6 秒，蜂鸣器报警后松开即可重置

### 3. 在 Home Assistant 中配置

1. 在 **设置** → **设备与服务** 中找到设备
2. 点击 **配置**
3. 选择要订阅的实体（最多 6 个）
4. 保存 - 显示屏将自动更新

### 备用：硬编码 WiFi（可选）

如果不想使用配网功能，可以修改代码：

```cpp
#define USE_WIFI_PROVISIONING false  // 禁用配网

const char* WIFI_SSID = "你的WiFi名称";
const char* WIFI_PASSWORD = "你的WiFi密码";
```

## 按设备类别颜色编码

| 设备类别 | 卡片颜色 |
|---------|---------|
| temperature | 红色 |
| humidity | 蓝色 |
| battery | 绿色 |
| illuminance | 黄色 |
| power/energy | 绿色 |
| 其他 | 黑色 |

## 显示布局

```
┌─────────────────────────────────────────────────────┐
│  [蓝色标题栏] Home Assistant Dashboard  [状态]      │
├───────────────┬───────────────┬───────────────────┬─┤
│ ▌ 卡片 1     │ ▌ 卡片 2     │ ▌ 卡片 3          │ │
│ ▌ [数值]     │ ▌ [数值]     │ ▌ [数值]          │ │
├───────────────┼───────────────┼───────────────────┼─┤
│ ▌ 卡片 4     │ ▌ 卡片 5     │ ▌ 卡片 6          │ │
│ ▌ [数值]     │ ▌ [数值]     │ ▌ [空]            │ │
├───────────────┴───────────────┴───────────────────┴─┤
│  设备 ID | IP 地址              | 最后刷新           │
└─────────────────────────────────────────────────────┘
```

（▌ = 每个卡片左侧的彩色强调条）

## 刷新逻辑

| 触发条件 | 说明 |
|---------|------|
| 初始刷新 | 首次数据收集后（等待 5 秒） |
| 配置变更 | 在 HA 中添加/删除实体时 |
| 定时刷新 | 每 5 分钟 |
| 连接变化 | HA 上线/掉线时 |

## 配置选项

| 选项 | 默认值 | 说明 |
|-----|-------|------|
| `USE_WIFI_PROVISIONING` | true | 启用网页配网 |
| `AP_SSID` | reTerminal_E1002_AP | 配网时的热点名称 |
| `PIN_RESET_BUTTON` | 3 | 重置按钮引脚 |
| `PIN_STATUS_LED` | 6 | 状态 LED 引脚 |
| `PIN_BUZZER` | 45 | 蜂鸣器引脚 |
| `DISPLAY_REFRESH_INTERVAL` | 300000ms | 定时刷新间隔（5分钟） |
| `DATA_COLLECTION_WAIT` | 5000ms | 初始刷新前等待时间 |
| `MAX_DISPLAY_ENTITIES` | 6 | 最大显示实体数 |

## LED 和蜂鸣器状态指示

| 状态 | LED 行为 | 蜂鸣器反馈 |
|-----|---------|----------|
| 启动 | 快闪 2 次 | - |
| 进入配网模式 | 慢闪 3 次 | - |
| WiFi 连接成功 | 快闪 3-5 次 | - |
| 重置按钮达到 6 秒 | 快闪后常亮 | 警报声（1500/1000Hz x3）+ 提示音 |
| WiFi 重置触发 | LED 熄灭 | 长鸣（800Hz，500ms） |

## 串口输出

通过 Serial1 输出调试信息（引脚 43/44）：
- 连接状态
- 实体更新
- 刷新触发

## 启动画面

显示彩色启动画面，包含：
- HA 标志
- 设备名称
- 连接状态
- IP 地址
- 底部彩色调色板条

## 故障排除

### 显示不更新
- 检查是否定义了 `EPAPER_ENABLE`
- 验证在 HA 中订阅了实体
- 检查 Serial1 输出的错误信息

### "EPAPER_ENABLE not defined"
- 在 TFT_eSPI/Seeed_GFX 的 User_Setup.h 中启用墨水屏

### 颜色显示不正确
- 六色墨水屏有限的颜色调色板
- 只使用 6 种支持的颜色

## 许可证

SeeedHADiscovery 库的一部分。

